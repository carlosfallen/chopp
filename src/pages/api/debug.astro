---
// FILE: src/pages/api/debug.astro
export const prerender = false;

const checks = {
  timestamp: new Date().toISOString(),
  runtime: {
    exists: !!Astro.locals.runtime,
    hasEnv: !!Astro.locals.runtime?.env,
    envKeys: Astro.locals.runtime?.env ? Object.keys(Astro.locals.runtime.env) : [],
    db: !!Astro.locals.runtime?.env?.DB,
    bucket: !!Astro.locals.runtime?.env?.BUCKET,
    cache: !!Astro.locals.runtime?.env?.CACHE,
  },
  database: {
    initialized: !!Astro.locals.db
  }
};

let dbTest = null;
if (Astro.locals.db) {
  try {
    const settings = await Astro.locals.db.getSettings();
    dbTest = {
      success: true,
      settingsKeys: Object.keys(settings)
    };
  } catch (error) {
    dbTest = {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error'
    };
  }
}
---

<!DOCTYPE html>
<html>
<head>
  <title>Debug - Chopp Delivery</title>
  <style>
    body {
      font-family: monospace;
      padding: 2rem;
      background: #0a0a0a;
      color: #fff;
    }
    pre {
      background: #1a1a1a;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-weight: bold;
    }
    .ok { background: #28a745; color: #fff; }
    .error { background: #dc3545; color: #fff; }
    h1 { color: #d4af37; }
    h2 { color: #ffbf00; margin-top: 2rem; }
  </style>
</head>
<body>
  <h1>üîç Chopp Delivery - Debug Panel</h1>
  
  <h2>Runtime Check</h2>
  <pre>{JSON.stringify(checks.runtime, null, 2)}</pre>
  
  <h2>Database Test</h2>
  {dbTest ? (
    <div>
      <span class={dbTest.success ? 'status ok' : 'status error'}>
        {dbTest.success ? '‚úì CONNECTED' : '‚úó ERROR'}
      </span>
      <pre>{JSON.stringify(dbTest, null, 2)}</pre>
    </div>
  ) : (
    <p>Database not initialized</p>
  )}
  
  <h2>Available APIs</h2>
  <ul>
    <li><a href="/api/health">/api/health</a> - Health check</li>
    <li><a href="/api/products">/api/products</a> - Products list</li>
    <li><a href="/api/settings">/api/settings</a> - Settings</li>
    <li><a href="/api/brands">/api/brands</a> - Brands</li>
    <li><a href="/api/testimonials">/api/testimonials</a> - Testimonials</li>
    <li><a href="/api/orders">/api/orders</a> - Orders</li>
  </ul>
</body>
</html>