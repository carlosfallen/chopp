---
// FILE: src/pages/admin/layout.astro
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Configurar Layout">
  <div class="admin-content">
    <div class="content-header">
      <div>
        <h1>Configura√ß√£o de Layout</h1>
        <p>Personalize apar√™ncia e conte√∫do da p√°gina inicial</p>
      </div>
      <button id="preview-btn" class="btn btn-secondary">
        üëÅÔ∏è Visualizar Altera√ß√µes
      </button>
    </div>

    <form id="layout-form" class="layout-form">
      <!-- Hero Section -->
      <div class="form-section">
        <h2>üéØ Se√ß√£o Hero (Principal)</h2>

        <div class="form-group">
          <label>T√≠tulo Principal</label>
          <textarea
            name="heroTitle"
            rows="3"
            placeholder="Linha 1&#10;Linha 2&#10;Linha 3"
            required></textarea>
          <small>Use quebras de linha para separar. A segunda linha ter√° destaque dourado.</small>
        </div>

        <div class="form-group">
          <label>Subt√≠tulo</label>
          <textarea
            name="heroSubtitle"
            rows="2"
            placeholder="Descri√ß√£o atrativa do servi√ßo..."
            required></textarea>
        </div>

        <div class="form-group">
          <label>Imagem Hero</label>
          <select id="image-selector-hero" class="image-select">
            <option value="">Carregando imagens...</option>
          </select>
          <input
            type="url"
            name="heroImage"
            id="heroImage"
            placeholder="ou cole URL diretamente" />
        </div>

        <div class="image-preview" id="hero-preview"></div>

        <div class="form-row">
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" name="showBadge" id="showBadge" checked />
              <span>Exibir badge "Melhor Chopp Delivery 2024"</span>
            </label>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" name="showStats" id="showStats" checked />
              <span>Exibir estat√≠sticas (5.000+ eventos, etc)</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Experience Section -->
      <div class="form-section">
        <h2>‚ú® Se√ß√£o Experi√™ncia Completa</h2>

        <div class="form-group">
          <label>T√≠tulo da Se√ß√£o</label>
          <input
            type="text"
            name="experienceTitle"
            id="experienceTitle"
            placeholder="Experi√™ncia completa de bar em casa"
            required />
        </div>

        <div class="form-group">
          <label>Subt√≠tulo</label>
          <textarea
            name="experienceSubtitle"
            id="experienceSubtitle"
            rows="2"
            placeholder="Chopeira, instala√ß√£o profissional e suporte durante todo o evento"
            required></textarea>
        </div>

        <div class="form-group">
          <label>Imagem de Fundo (opcional)</label>
          <select id="image-selector-experience" class="image-select">
            <option value="">Carregando imagens...</option>
          </select>
          <input
            type="url"
            name="experienceBackgroundImage"
            id="experienceBackgroundImage"
            placeholder="ou cole URL diretamente ou deixe vazio para sem imagem" />
        </div>

        <div class="image-preview" id="experience-preview"></div>
      </div>

      <!-- Cores e Estilo -->
      <div class="form-section">
        <h2>üé® Cores e Estilo</h2>

        <div class="form-row">
          <div class="form-group">
            <label>Cor de Fundo</label>
            <div class="color-picker-group">
              <input
                type="color"
                name="backgroundColor"
                id="backgroundColor"
                value="#0a0a0a" />
              <input
                type="text"
                id="backgroundColor-text"
                value="#0a0a0a"
                pattern="^#[0-9A-Fa-f]{6}$" />
            </div>
          </div>

          <div class="form-group">
            <label>Cor Prim√°ria (Dourado)</label>
            <div class="color-picker-group">
              <input
                type="color"
                name="primaryColor"
                id="primaryColor"
                value="#d4af37" />
              <input
                type="text"
                id="primaryColor-text"
                value="#d4af37"
                pattern="^#[0-9A-Fa-f]{6}$" />
            </div>
          </div>

          <div class="form-group">
            <label>Cor Secund√°ria (√Çmbar)</label>
            <div class="color-picker-group">
              <input
                type="color"
                name="secondaryColor"
                id="secondaryColor"
                value="#ffbf00" />
              <input
                type="text"
                id="secondaryColor-text"
                value="#ffbf00"
                pattern="^#[0-9A-Fa-f]{6}$" />
            </div>
          </div>
        </div>

        <div class="color-preview">
          <div class="preview-card">
            <div class="preview-title">Pr√©via de Cores</div>
            <div class="preview-palette">
              <div class="palette-item">
                <div class="palette-color" id="preview-bg" style="background: #0a0a0a;"></div>
                <span>Fundo</span>
              </div>
              <div class="palette-item">
                <div class="palette-color" id="preview-primary" style="background: #d4af37;"></div>
                <span>Prim√°ria</span>
              </div>
              <div class="palette-item">
                <div class="palette-color" id="preview-secondary" style="background: #ffbf00;"></div>
                <span>Secund√°ria</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- A√ß√µes -->
      <div class="form-actions">
        <button type="button" id="reset-btn" class="btn btn-secondary">
          Restaurar Padr√£o
        </button>
        <button type="submit" class="btn btn-primary">
          üíæ Salvar Configura√ß√µes
        </button>
      </div>
    </form>
  </div>
</AdminLayout>

<style>
  .admin-content {
    padding: var(--spacing-2xl);
    max-width: 1200px;
  }

  .content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-2xl);
    flex-wrap: wrap;
    gap: var(--spacing-md);
  }

  .layout-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2xl);
  }

  .form-section {
    background: var(--color-bg-secondary);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-xl);
  }

  .form-section h2 {
    margin-bottom: var(--spacing-lg);
    color: var(--color-accent-gold);
    font-size: 1.5rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
  }

  .form-group {
    margin-bottom: var(--spacing-md);
  }

  .form-group label {
    display: block;
    margin-bottom: var(--spacing-xs);
    font-weight: 600;
    color: var(--color-text-primary);
  }

  .form-group input[type="text"],
  .form-group input[type="url"],
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: var(--spacing-sm);
    background: var(--color-bg-primary);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--border-radius);
    color: var(--color-text-primary);
    font-family: inherit;
  }

  .form-group textarea {
    resize: vertical;
    min-height: 80px;
  }

  .form-group small {
    display: block;
    margin-top: var(--spacing-xs);
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    cursor: pointer;
    font-weight: 500;
  }

  .checkbox-label input[type="checkbox"] {
    width: auto;
    cursor: pointer;
  }

  .color-picker-group {
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
  }

  .color-picker-group input[type="color"] {
    width: 60px;
    height: 40px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--border-radius);
    cursor: pointer;
  }

  .color-picker-group input[type="text"] {
    flex: 1;
  }

  .color-preview {
    margin-top: var(--spacing-lg);
  }

  .preview-card {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
  }

  .preview-title {
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--color-text-secondary);
  }

  .preview-palette {
    display: flex;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
  }

  .palette-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-xs);
  }

  .palette-color {
    width: 80px;
    height: 80px;
    border-radius: var(--border-radius);
    border: 2px solid rgba(255, 255, 255, 0.1);
    box-shadow: var(--shadow-md);
  }

  .palette-item span {
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  .image-preview {
    margin-top: var(--spacing-md);
    border-radius: var(--border-radius);
    overflow: hidden;
  }

  .image-preview img {
    width: 100%;
    max-height: 400px;
    object-fit: cover;
  }

  .image-select {
    margin-bottom: var(--spacing-sm);
  }

  .form-actions {
    display: flex;
    gap: var(--spacing-md);
    justify-content: flex-end;
    padding-top: var(--spacing-lg);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  @media (max-width: 768px) {
    .content-header {
      flex-direction: column;
      align-items: stretch;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .form-actions {
      flex-direction: column;
    }
  }
</style>

<script>
  // Carregar imagens do R2
  async function loadImages() {
    try {
      const response = await fetch('/api/images');
      if (!response.ok) throw new Error('Failed to load images');

      const data = await response.json();

      // Populate hero image selector
      const heroSelector = document.getElementById('image-selector-hero') as HTMLSelectElement;
      if (heroSelector && data.images) {
        heroSelector.innerHTML = '<option value="">Selecione uma imagem</option>';
        data.images.forEach((img: any) => {
          const option = document.createElement('option');
          option.value = img.url;
          option.textContent = img.key;
          heroSelector.appendChild(option);
        });
      }

      // Populate experience image selector
      const experienceSelector = document.getElementById('image-selector-experience') as HTMLSelectElement;
      if (experienceSelector && data.images) {
        experienceSelector.innerHTML = '<option value="">Selecione uma imagem (ou deixe vazio)</option>';
        data.images.forEach((img: any) => {
          const option = document.createElement('option');
          option.value = img.url;
          option.textContent = img.key;
          experienceSelector.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading images:', error);
    }
  }

  // Carregar configura√ß√µes existentes
  async function loadConfig() {
    try {
      const response = await fetch('/api/layout-config');
      if (!response.ok) throw new Error('Failed to load config');

      const config = await response.json();
      const form = document.getElementById('layout-form') as HTMLFormElement;

      if (form) {
        Object.keys(config).forEach(key => {
          const input = form.elements.namedItem(key) as HTMLInputElement | HTMLTextAreaElement;
          if (input) {
            if (input.type === 'checkbox') {
              (input as HTMLInputElement).checked = config[key];
            } else {
              input.value = config[key];
            }
          }
        });

        // Atualizar inputs de texto das cores
        ['backgroundColor', 'primaryColor', 'secondaryColor'].forEach(key => {
          const textInput = document.getElementById(`${key}-text`) as HTMLInputElement;
          if (textInput) textInput.value = config[key];
        });

        // Atualizar preview de imagem
        if (config.heroImage) {
          updateImagePreview(config.heroImage);
        }

        // Atualizar preview de cores
        updateColorPreviews();
      }
    } catch (error) {
      console.error('Error loading config:', error);
    }
  }

  // Atualizar preview de imagem
  function updateImagePreview(url: string) {
    const preview = document.getElementById('hero-preview');
    if (preview && url) {
      preview.innerHTML = `<img src="${url}" alt="Hero preview" />`;
    }
  }

  // Atualizar previews de cores
  function updateColorPreviews() {
    const bgColor = (document.getElementById('backgroundColor') as HTMLInputElement).value;
    const primaryColor = (document.getElementById('primaryColor') as HTMLInputElement).value;
    const secondaryColor = (document.getElementById('secondaryColor') as HTMLInputElement).value;

    document.getElementById('preview-bg')!.style.background = bgColor;
    document.getElementById('preview-primary')!.style.background = primaryColor;
    document.getElementById('preview-secondary')!.style.background = secondaryColor;
  }

  // Sincronizar color picker com input de texto
  ['backgroundColor', 'primaryColor', 'secondaryColor'].forEach(id => {
    const colorInput = document.getElementById(id) as HTMLInputElement;
    const textInput = document.getElementById(`${id}-text`) as HTMLInputElement;

    colorInput?.addEventListener('input', (e) => {
      const value = (e.target as HTMLInputElement).value;
      textInput.value = value;
      updateColorPreviews();
    });

    textInput?.addEventListener('input', (e) => {
      const value = (e.target as HTMLInputElement).value;
      if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
        colorInput.value = value;
        updateColorPreviews();
      }
    });
  });

  // Seletor de imagem Hero
  const imageSelector = document.getElementById('image-selector-hero') as HTMLSelectElement;
  const heroImageInput = document.getElementById('heroImage') as HTMLInputElement;

  imageSelector?.addEventListener('change', (e) => {
    const url = (e.target as HTMLSelectElement).value;
    if (url) {
      heroImageInput.value = url;
      updateImagePreview(url);
    }
  });

  heroImageInput?.addEventListener('input', (e) => {
    const url = (e.target as HTMLInputElement).value;
    if (url) updateImagePreview(url);
  });

  // Seletor de imagem Experience
  const experienceImageSelector = document.getElementById('image-selector-experience') as HTMLSelectElement;
  const experienceImageInput = document.getElementById('experienceBackgroundImage') as HTMLInputElement;

  experienceImageSelector?.addEventListener('change', (e) => {
    const url = (e.target as HTMLSelectElement).value;
    experienceImageInput.value = url;
    if (url) updateExperiencePreview(url);
  });

  experienceImageInput?.addEventListener('input', (e) => {
    const url = (e.target as HTMLInputElement).value;
    if (url) updateExperiencePreview(url);
    else {
      const preview = document.getElementById('experience-preview');
      if (preview) preview.innerHTML = '';
    }
  });

  function updateExperiencePreview(url: string) {
    const preview = document.getElementById('experience-preview');
    if (preview) {
      preview.innerHTML = `<img src="${url}" alt="Preview" style="max-width: 100%; max-height: 300px; border-radius: var(--border-radius); border: 2px solid var(--color-accent-gold);" />`;
    }
  }

  // Preview de altera√ß√µes
  document.getElementById('preview-btn')?.addEventListener('click', () => {
    window.open('/', '_blank');
  });

  // Restaurar padr√£o
  document.getElementById('reset-btn')?.addEventListener('click', () => {
    if (confirm('Deseja realmente restaurar as configura√ß√µes padr√£o?')) {
      const form = document.getElementById('layout-form') as HTMLFormElement;
      form.reset();
      (document.getElementById('heroTitle') as HTMLTextAreaElement).value = 'Chopp de Bar\nNa Sua Casa\nSem Complica√ß√£o';
      (document.getElementById('heroSubtitle') as HTMLTextAreaElement).value = 'Chopeira profissional gratuita, entrega express e instala√ß√£o completa. Transforme qualquer momento em celebra√ß√£o.';
      (document.getElementById('backgroundColor') as HTMLInputElement).value = '#0a0a0a';
      (document.getElementById('primaryColor') as HTMLInputElement).value = '#d4af37';
      (document.getElementById('secondaryColor') as HTMLInputElement).value = '#ffbf00';
      updateColorPreviews();
    }
  });

  // Salvar configura√ß√µes
  const form = document.getElementById('layout-form');
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target as HTMLFormElement);
    const config: any = {};

    formData.forEach((value, key) => {
      config[key] = value;
    });

    // Converter checkboxes para boolean
    config.showBadge = (document.getElementById('showBadge') as HTMLInputElement).checked;
    config.showStats = (document.getElementById('showStats') as HTMLInputElement).checked;

    try {
      const response = await fetch('/api/layout-config', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.details || 'Failed to save');
      }

      alert('‚úÖ Configura√ß√µes salvas com sucesso!\n\nA p√°gina inicial foi atualizada.');
    } catch (error) {
      console.error('Error saving config:', error);
      alert(`‚ùå Erro ao salvar: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  });

  // Inicializar
  loadImages();
  loadConfig();
</script>
