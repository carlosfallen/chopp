---
// FILE: src/pages/admin/media.astro
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Gerenciar M√≠dia">
  <div class="admin-content">
    <div class="content-header">
      <div>
        <h1>Biblioteca de M√≠dia</h1>
        <p>Gerencie todas as imagens do seu site</p>
      </div>
      <button class="btn btn-primary" id="upload-btn">
        <span>üì§</span>
        <span>Upload de Imagem</span>
      </button>
    </div>

    <div class="upload-area" id="upload-area" style="display: none;">
      <div class="upload-box">
        <div class="upload-icon">‚òÅÔ∏è</div>
        <h3>Arraste e solte ou clique para selecionar</h3>
        <p>Formatos aceitos: JPG, PNG, GIF, WebP (m√°x 5MB)</p>
        <input type="file" id="file-input" accept="image/*" multiple hidden />
        <button type="button" class="btn btn-secondary" id="select-files-btn">
          Selecionar Arquivos
        </button>
      </div>
      <div id="upload-progress" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <p id="upload-status">Enviando...</p>
      </div>
    </div>

    <div class="media-grid" id="media-grid">
      <div class="loading">Carregando imagens...</div>
    </div>
  </div>
</AdminLayout>

<style>
  .admin-content {
    padding: var(--spacing-2xl);
    max-width: 1400px;
  }

  .content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-2xl);
    flex-wrap: wrap;
    gap: var(--spacing-md);
  }

  .content-header h1 {
    font-size: 2rem;
    margin-bottom: var(--spacing-xs);
  }

  .content-header p {
    color: var(--color-text-muted);
  }

  .upload-area {
    background: var(--color-bg-secondary);
    border: 2px dashed rgba(212, 175, 55, 0.3);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-2xl);
    margin-bottom: var(--spacing-2xl);
    transition: all 0.3s ease;
  }

  .upload-area.dragover {
    border-color: var(--color-accent-gold);
    background: rgba(212, 175, 55, 0.05);
  }

  .upload-box {
    text-align: center;
  }

  .upload-icon {
    font-size: 4rem;
    margin-bottom: var(--spacing-md);
  }

  .upload-box h3 {
    margin-bottom: var(--spacing-sm);
    color: var(--color-text-primary);
  }

  .upload-box p {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-lg);
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: var(--spacing-md);
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-accent-gold), var(--color-accent-amber));
    width: 0%;
    transition: width 0.3s ease;
  }

  #upload-status {
    text-align: center;
    color: var(--color-text-secondary);
  }

  .media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: var(--spacing-lg);
  }

  .media-item {
    position: relative;
    background: var(--color-bg-secondary);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--border-radius);
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .media-item:hover {
    border-color: var(--color-accent-gold);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(212, 175, 55, 0.2);
  }

  .media-item img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    display: block;
  }

  .media-info {
    padding: var(--spacing-md);
  }

  .media-name {
    font-size: 0.875rem;
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-xs);
    word-break: break-all;
  }

  .media-url {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    font-family: monospace;
    word-break: break-all;
  }

  .media-actions {
    display: flex;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  .media-actions button {
    flex: 1;
    padding: var(--spacing-xs);
    font-size: 0.875rem;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--color-text-secondary);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .media-actions button:hover {
    border-color: var(--color-accent-gold);
    color: var(--color-accent-gold);
  }

  .loading {
    grid-column: 1 / -1;
    text-align: center;
    padding: var(--spacing-2xl);
    color: var(--color-text-muted);
  }

  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: var(--spacing-3xl);
    color: var(--color-text-muted);
  }

  .empty-state-icon {
    font-size: 4rem;
    margin-bottom: var(--spacing-md);
  }
</style>

<script>
  let uploadedFiles: File[] = [];

  async function loadImages() {
    const grid = document.getElementById('media-grid');
    if (!grid) return;

    try {
      const response = await fetch('/api/images');
      if (!response.ok) throw new Error('Failed to load images');

      const data = await response.json();

      if (!data.images || data.images.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üñºÔ∏è</div>
            <p>Nenhuma imagem encontrada</p>
            <p style="font-size: 0.875rem; margin-top: var(--spacing-sm);">Fa√ßa upload da primeira imagem para come√ßar</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = data.images.map((img: any) => `
        <div class="media-item">
          <img src="${img.url}" alt="${img.key}" loading="lazy" />
          <div class="media-info">
            <div class="media-name">${img.key}</div>
            <div class="media-url">${img.url}</div>
          </div>
          <div class="media-actions">
            <button onclick="copyUrl('${img.url}')">üìã Copiar URL</button>
            <button onclick="deleteImage('${img.key}')" style="color: #ff6b6b;">üóëÔ∏è Deletar</button>
          </div>
        </div>
      `).join('');
    } catch (error) {
      console.error('Error loading images:', error);
      grid.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ùå</div>
          <p>Erro ao carregar imagens</p>
        </div>
      `;
    }
  }

  (window as any).copyUrl = (url: string) => {
    navigator.clipboard.writeText(url);
    alert('‚úÖ URL copiada para √°rea de transfer√™ncia!');
  };

  (window as any).deleteImage = async (key: string) => {
    if (!confirm(`Tem certeza que deseja deletar "${key}"?`)) return;

    try {
      const response = await fetch(`/api/images/${encodeURIComponent(key)}`, {
        method: 'DELETE'
      });

      if (!response.ok) throw new Error('Failed to delete');

      alert('‚úÖ Imagem deletada com sucesso!');
      loadImages();
    } catch (error) {
      console.error('Error deleting image:', error);
      alert('‚ùå Erro ao deletar imagem');
    }
  };

  // Toggle upload area
  const uploadBtn = document.getElementById('upload-btn');
  const uploadArea = document.getElementById('upload-area');

  uploadBtn?.addEventListener('click', () => {
    if (uploadArea) {
      uploadArea.style.display = uploadArea.style.display === 'none' ? 'block' : 'none';
    }
  });

  // File selection
  const selectFilesBtn = document.getElementById('select-files-btn');
  const fileInput = document.getElementById('file-input') as HTMLInputElement;

  selectFilesBtn?.addEventListener('click', () => fileInput?.click());

  fileInput?.addEventListener('change', async (e) => {
    const files = (e.target as HTMLInputElement).files;
    if (files && files.length > 0) {
      await uploadFiles(Array.from(files));
    }
  });

  // Drag and drop
  const uploadBox = uploadArea;

  uploadBox?.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadBox.classList.add('dragover');
  });

  uploadBox?.addEventListener('dragleave', () => {
    uploadBox.classList.remove('dragover');
  });

  uploadBox?.addEventListener('drop', async (e) => {
    e.preventDefault();
    uploadBox.classList.remove('dragover');

    const files = e.dataTransfer?.files;
    if (files && files.length > 0) {
      await uploadFiles(Array.from(files));
    }
  });

  async function uploadFiles(files: File[]) {
    const progressDiv = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    const uploadStatus = document.getElementById('upload-status');

    if (!progressDiv || !progressFill || !uploadStatus) return;

    progressDiv.style.display = 'block';

    for (let i = 0; i < files.length; i++) {
      const file = files[i];

      if (!file.type.startsWith('image/')) {
        alert(`‚ùå ${file.name} n√£o √© uma imagem v√°lida`);
        continue;
      }

      if (file.size > 5 * 1024 * 1024) {
        alert(`‚ùå ${file.name} √© muito grande (m√°x 5MB)`);
        continue;
      }

      uploadStatus.textContent = `Enviando ${file.name} (${i + 1}/${files.length})...`;
      progressFill.style.width = `${((i + 0.5) / files.length) * 100}%`;

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) throw new Error('Upload failed');

        const result = await response.json();
        console.log('‚úÖ Uploaded:', result);
      } catch (error) {
        console.error('Error uploading:', error);
        alert(`‚ùå Erro ao enviar ${file.name}`);
      }

      progressFill.style.width = `${((i + 1) / files.length) * 100}%`;
    }

    uploadStatus.textContent = '‚úÖ Upload conclu√≠do!';

    setTimeout(() => {
      progressDiv.style.display = 'none';
      progressFill.style.width = '0%';
      if (fileInput) fileInput.value = '';
      loadImages();
    }, 2000);
  }

  // Initial load
  loadImages();
</script>
