---
// Experience otimizado - Video carousel + CSS + Intersection Observer (sem GSAP)
const videos = [
  {
    title: 'Chopeira servindo pint cremoso',
    description: 'Close em copo sendo preenchido com espuma cremosa direto da torneira.',
    src: 'https://videocdn.cdnpk.net/videos/55817ebb-69b1-4316-8c62-4257f317f7a3/horizontal/previews/clear/large.mp4?token=exp=1764801087~hmac=8e711a41b59a05f81cfaaaecd34e1215cb773d8a5c1be1e6af3545bbdfe821e3',
    accent: '#FFB800'
  },
  {
    title: 'Fluxo perfeito na torre',
    description: 'Barril regulado gelando o chopp enquanto a torneira abre o fluxo.',
    src: 'https://videocdn.cdnpk.net/videos/5373f6af-ecb4-4e85-8772-cbc93d02b8ff/horizontal/previews/clear/large.mp4?token=exp=1764799869~hmac=151b2e10bf779c4dbb6d5a0798d2991eb73d076eecf53b971d2c6ea36d58c40d',
    accent: '#FF6B35'
  },
  {
    title: 'Tap duplo para eventos',
    description: 'Dois taps atendendo convidados ao mesmo tempo, sem fila.',
    src: 'https://videocdn.cdnpk.net/videos/9cc7aa47-4a75-5576-88e1-ca2d6720a8f3/horizontal/previews/clear/large.mp4?token=exp=1764799818~hmac=1a865bf9e464dbe234dd56caf66292e6684131b2ef7b8d878c6d2cc85ff333d7',
    accent: '#4ECDC4'
  }
];
---

<div class="experience-container" id="experience-container">
  <div class="carousel-wrapper">
    <div class="carousel-main">
      <div class="carousel-track" id="carousel-track">
        {videos.map((video, index) => (
          <div class="carousel-slide">
            <div class="video-wrapper" style={`--accent-color: ${video.accent}`}>
              <div class="video-frame">
                <video
                  class="video-element"
                  data-index={index}
                  autoplay={index === 0}
                  muted
                  loop
                  playsinline
                  preload="metadata"
                >
                  <source src={video.src} type="video/mp4" />
                </video>
              </div>
              <div class="video-gradient"></div>
            </div>

            <div class="slide-info">
              <div class="slide-meta">
                <span class="slide-index">0{index + 1}</span>
                <span class="slide-divider">/</span>
                <span class="slide-total">0{videos.length}</span>
              </div>
              <h3 class="slide-title">{video.title}</h3>
              <p class="slide-description">{video.description}</p>
            </div>
          </div>
        ))}
      </div>
    </div>

    <div class="carousel-controls">
      <button
        class="control-btn control-prev"
        type="button"
        id="prev-btn"
        aria-label="Vídeo anterior"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>

      <div class="carousel-dots" id="carousel-dots">
        {videos.map((video, index) => (
          <button
            type="button"
            class={`dot ${index === 0 ? 'active' : ''}`}
            data-index={index}
            style={`--accent: ${video.accent}`}
            aria-label={`Ir para vídeo ${index + 1}`}
          >
            <span class="dot-fill"></span>
          </button>
        ))}
      </div>

      <button
        class="control-btn control-next"
        type="button"
        id="next-btn"
        aria-label="Próximo vídeo"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="experience-cta">
    <p class="cta-text">Pronto para levar essa experiência para sua casa?</p>
    <a href="/loja" class="cta-button">
      <span>Ver Chopeiras Disponíveis</span>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
    </a>
  </div>
</div>

<style>
  .experience-container {
    opacity: 0;
    transform: translateY(80px);
    transition: all 1.2s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .experience-container.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .carousel-wrapper {
    position: relative;
    max-width: 1200px;
    margin: 0 auto;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 2rem;
    padding: 2rem;
    overflow: hidden;
  }

  .carousel-main {
    overflow: hidden;
    border-radius: 1.5rem;
  }

  .carousel-track {
    display: flex;
    transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .carousel-slide {
    min-width: 100%;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .video-wrapper {
    position: relative;
    border-radius: 1.5rem;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  }

  .video-frame {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    background: rgba(0, 0, 0, 0.3);
  }

  .video-element {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .video-gradient {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      transparent 50%,
      rgba(0, 0, 0, 0.3)
    );
    pointer-events: none;
  }

  .slide-info {
    text-align: center;
    padding: 1rem;
  }

  .slide-meta {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
  }

  .slide-index {
    color: var(--color-accent-gold);
    font-weight: 700;
  }

  .slide-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--color-text-primary);
    margin-bottom: 0.75rem;
  }

  .slide-description {
    font-size: 1rem;
    color: var(--color-text-muted);
    line-height: 1.6;
  }

  .carousel-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    margin-top: 2rem;
  }

  .control-btn {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    color: var(--color-text-primary);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .control-btn:hover:not(:disabled) {
    background: var(--color-accent-gold);
    border-color: var(--color-accent-gold);
    color: var(--color-bg-primary);
    transform: scale(1.1);
  }

  .control-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .carousel-dots {
    display: flex;
    gap: 0.75rem;
  }

  .dot {
    width: 12px;
    height: 12px;
    padding: 0;
    background: transparent;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
  }

  .dot-fill {
    position: absolute;
    inset: 2px;
    background: var(--accent, var(--color-accent-gold));
    border-radius: 50%;
    opacity: 0;
    transform: scale(0);
    transition: all 0.3s ease;
  }

  .dot.active .dot-fill {
    opacity: 1;
    transform: scale(1);
  }

  .dot:hover {
    border-color: var(--accent, var(--color-accent-gold));
    transform: scale(1.2);
  }

  .experience-cta {
    margin-top: 3rem;
    padding: 2.5rem;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(255, 191, 0, 0.05));
    border: 1px solid rgba(212, 175, 55, 0.2);
    border-radius: 1.5rem;
    text-align: center;
  }

  .cta-text {
    font-size: 1.25rem;
    color: var(--color-text-secondary);
    margin-bottom: 1.5rem;
  }

  .cta-button {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, var(--color-accent-gold), var(--color-accent-amber));
    color: var(--color-bg-primary);
    font-weight: 700;
    border-radius: 0.75rem;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .cta-button:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(212, 175, 55, 0.4);
  }

  /* Responsivo */
  @media (max-width: 768px) {
    .carousel-wrapper {
      padding: 1.5rem;
      border-radius: 1.5rem;
    }

    .slide-title {
      font-size: 1.5rem;
    }

    .slide-description {
      font-size: 0.9375rem;
    }

    .carousel-controls {
      gap: 1rem;
    }

    .control-btn {
      width: 40px;
      height: 40px;
    }

    .control-btn svg {
      width: 20px;
      height: 20px;
    }

    .experience-cta {
      padding: 2rem;
    }

    .cta-text {
      font-size: 1.125rem;
    }
  }

  @media (max-width: 480px) {
    .carousel-wrapper {
      padding: 1.25rem;
    }

    .slide-info {
      padding: 0.75rem;
    }

    .slide-title {
      font-size: 1.25rem;
    }

    .slide-description {
      font-size: 0.875rem;
    }

    .experience-cta {
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .cta-text {
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .cta-button {
      padding: 0.875rem 1.5rem;
      font-size: 0.9375rem;
    }
  }

  @media (max-width: 359px) {
    .carousel-wrapper {
      padding: 1rem;
      border-radius: 1.25rem;
    }

    .carousel-main {
      border-radius: 1rem;
    }

    .video-wrapper {
      border-radius: 1rem;
    }

    .slide-info {
      padding: 0.5rem;
    }

    .slide-title {
      font-size: 1.125rem;
      margin-bottom: 0.5rem;
    }

    .slide-description {
      font-size: 0.8125rem;
    }

    .carousel-controls {
      margin-top: 1.5rem;
      gap: 0.75rem;
    }

    .control-btn {
      width: 36px;
      height: 36px;
    }

    .control-btn svg {
      width: 18px;
      height: 18px;
    }

    .dot {
      width: 10px;
      height: 10px;
    }

    .carousel-dots {
      gap: 0.5rem;
    }

    .experience-cta {
      padding: 1.25rem;
      border-radius: 1.25rem;
    }

    .cta-text {
      font-size: 0.9375rem;
    }

    .cta-button {
      padding: 0.75rem 1.25rem;
      font-size: 0.875rem;
    }

    .cta-button svg {
      width: 18px;
      height: 18px;
    }
  }

  /* Acessibilidade */
  @media (prefers-reduced-motion: reduce) {
    .experience-container,
    .carousel-track {
      transition: none !important;
    }

    .experience-container {
      opacity: 1 !important;
      transform: none !important;
    }
  }
</style>

<script>
  // Video carousel com JS mínimo
  const track = document.getElementById('carousel-track');
  const dots = document.querySelectorAll('.dot');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const videos = document.querySelectorAll('.video-element');
  const wrapper = document.querySelector('.carousel-wrapper');

  let currentIndex = 0;
  let autoplayInterval: number | undefined;
  let isTransitioning = false;

  function pauseAllVideos() {
    videos.forEach(video => (video as HTMLVideoElement).pause());
  }

  function playCurrentVideo() {
    const currentVideo = videos[currentIndex] as HTMLVideoElement;
    if (currentVideo) {
      currentVideo.currentTime = 0;
      currentVideo.play().catch(() => {});
    }
  }

  function updateCarousel() {
    if (!track) return;

    track.style.transform = `translateX(-${currentIndex * 100}%)`;

    dots.forEach((dot, index) => {
      if (index === currentIndex) {
        dot.classList.add('active');
      } else {
        dot.classList.remove('active');
      }
    });

    pauseAllVideos();
    setTimeout(() => playCurrentVideo(), 100);
  }

  function goTo(index: number) {
    if (isTransitioning) return;

    isTransitioning = true;
    currentIndex = (index + videos.length) % videos.length;
    updateCarousel();

    setTimeout(() => {
      isTransitioning = false;
    }, 700);
  }

  function startAutoplay() {
    stopAutoplay();
    autoplayInterval = window.setInterval(() => {
      goTo(currentIndex + 1);
    }, 12000);
  }

  function stopAutoplay() {
    if (autoplayInterval) {
      clearInterval(autoplayInterval);
      autoplayInterval = undefined;
    }
  }

  // Controls
  prevBtn?.addEventListener('click', () => goTo(currentIndex - 1));
  nextBtn?.addEventListener('click', () => goTo(currentIndex + 1));

  dots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      goTo(index);
      startAutoplay();
    });
  });

  // Pause autoplay on hover/touch
  wrapper?.addEventListener('mouseenter', stopAutoplay);
  wrapper?.addEventListener('mouseleave', startAutoplay);
  wrapper?.addEventListener('touchstart', stopAutoplay);

  // Intersection Observer for fade-in
  const container = document.getElementById('experience-container');
  if (container) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.1, rootMargin: '0px 0px -100px 0px' }
    );

    observer.observe(container);
  }

  // Initialize
  playCurrentVideo();
  startAutoplay();

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    stopAutoplay();
    pauseAllVideos();
  });
</script>
